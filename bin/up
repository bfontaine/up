#! /bin/bash
#
# up
#
# Author: Baptiste Fontaine
# License: MIT
# Version: 0.1.0
#
# URI: github.com/bfontaine/up
#

__up() {

    local VERSION='0.1.0'
    local COMMANDS="$HOME/.up-commands"

    print_commands() {
        cat $COMMANDS || 0
    }

    add_command() {
        cmd=$1
        shift
        echo "$cmd:$*" >> $COMMANDS
    }

    rm_command() {
        # we can't reply on 'sponge', it's not installed by default
        grep -v "^$1:" $COMMANDS > .uprm
        mv .uprm $COMMANDS 
    }

    exec_command() {
        eval `grep "^$1:" $COMMANDS | cut -d: -f2`
    }

    print_usage() {
        echo "Usage:
    up --list                # list all commands
    up --add <alias <cmd>    # add a command
    up --rm <alias> <cmd>    # remove a command
    up <alias> [<alias> ...] # execute a set of commands
    up --version             # display the version number and exit
    up --help                # display this text and exit"
    }

    print_version() {
        echo "up v$VERSION - github.com/bfontaine/up"
    }

    init_commands() {
        tee $COMMANDS <<EOC >/dev/null
brew: brew update && brew upgrade
gem: gem update
opam: opam update && opam upgrade
EOC
    }

    ###

    if [ $# -eq 0 ]; then
        print_usage
        return 0
    fi

    [ ! -f "$COMMANDS" ] && init_commands

    case "$1" in
        -v|--version|-version)
            print_version
            return 0;;

        -h|--help|-help)
            print_usage
            return 0;;

        --ls|--list|-ls|-list)
            print_commands
            return 0;;
            
        --add|-add)
            shift
            add_command $*
            return 0;;

        --rm|-rm)
            shift
            rm_command $1
            return 0;;

        -*)
            echo "Unrecognized option: $1"
            print_usage
            return 1;;

        *)
            while [ $# -gt 0 ]; do
                exec_command $1
                shift
            done
            return 0;;
    esac
}

__up $*

